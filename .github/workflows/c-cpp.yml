name: build nginx

on:
  repository_dispatch:
    workflow_dispatch:
      inputs:
        ssh:
          description: 'SSH connection to Actions'
          required: false
          default: 'false'

  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout workflow
      uses: actions/checkout@v2
      
    - name: Clone Openssl
      run: |
        git clone https://github.com/openssl/openssl.git -b OpenSSL_1_1_1-stable openssl
    - name: Clone ngx_http_proxy_connect_module
      run: |
        git clone https://github.com/chobits/ngx_http_proxy_connect_module.git
    - name: Clone nginx
      run: |
        git clone https://github.com/nginx/nginx.git
    - name: Compile
      run: |
        cur_path=`pwd`
        cd nginx
        mv auto/configure configure
        patch -p1 <../ngx_http_proxy_connect_module/patch/proxy_connect_rewrite_1018.patch
        ./configure  --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --modules-path=/usr/lib/nginx/modules --http-client-body-temp-path=/var/lib/nginx/body --http-proxy-temp-path=/var/lib/nginx/proxy --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --without-http_memcached_module --without-http_uwsgi_module --without-http_scgi_module --with-http_gzip_static_module --with-http_ssl_module --with-http_stub_status_module --with-http_v2_module --with-openssl="$cur_path/openssl" --with-openssl-opt=enable-tls1_3 --with-stream --with-stream_ssl_module --add-module="$cur_path/ngx_http_proxy_connect_module"
        make
        cp ${cur_path}/nginx-workflow/install.sh ${cur_path}/nginx/install.sh
        
    - name : Upload artifact
      uses: actions/upload-artifact@master
      with:
        name: nginx
        path: |
          nginx/install.sh
          nginx/docs
          nginx/conf
          nginx/objs/nginx
